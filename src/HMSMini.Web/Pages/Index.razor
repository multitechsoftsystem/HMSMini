@page "/"
@inject IApiClientService ApiClient
@inject IAuthenticationService AuthService
@inject NavigationManager Navigation

<PageTitle>Dashboard - HMS Mini</PageTitle>

@if (!isAuthenticated)
{
    <p>Redirecting to login...</p>
}
else
{
    <div class="dashboard">
        <h2 class="mb-4">Room Status Dashboard</h2>

        <!-- Status Summary Cards -->
        <div class="status-summary">
            <div class="status-card total">
                <div class="status-label">Total Rooms</div>
                <div class="status-count">@totalRooms</div>
            </div>
            <div class="status-card available">
                <div class="status-label">Available</div>
                <div class="status-count">@availableCount</div>
            </div>
            <div class="status-card occupied">
                <div class="status-label">Occupied</div>
                <div class="status-count">@occupiedCount</div>
            </div>
            <div class="status-card dirty">
                <div class="status-label">Dirty</div>
                <div class="status-count">@dirtyCount</div>
            </div>
            <div class="status-card maintenance">
                <div class="status-label">Maintenance</div>
                <div class="status-count">@maintenanceCount</div>
            </div>
            <div class="status-card blocked">
                <div class="status-label">Blocked</div>
                <div class="status-count">@blockedCount</div>
            </div>
        </div>

        <!-- Room Chart -->
        <h4 class="mb-3">All Rooms</h4>
        @if (loading)
        {
            <div class="text-center">
                <div class="spinner-border"></div>
            </div>
        }
        else
        {
            <div class="room-chart">
                @foreach (var room in rooms.OrderBy(r => r.RoomNumber))
                {
                    <div class="room-card @GetRoomStatusClass(room.RoomStatus)" @onclick="() => SelectRoom(room)">
                        <div>
                            <div class="room-number">@room.RoomNumber</div>
                            <div class="room-type">@room.RoomTypeName</div>
                            <span class="room-status-badge bg-@GetStatusColor(room.RoomStatus)">
                                @room.RoomStatusName
                            </span>
                        </div>

                        @if (room.RoomStatus == 1 && roomOccupancy.ContainsKey(room.RoomId))
                        {
                            var occupancy = roomOccupancy[room.RoomId];
                            <div class="room-guest-info">
                                <div class="room-guest-name">
                                    <i class="bi bi-person-fill"></i> @occupancy.GuestName
                                </div>
                                <div class="room-checkout-date">
                                    <i class="bi bi-calendar-x"></i> Checkout: @occupancy.CheckoutDate.ToShortDateString()
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }

        <!-- Upcoming Check-Ins -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Today's Arrivals (@todayArrivals.Count)</h5>
                    </div>
                    <div class="card-body">
                        @if (todayArrivals.Any())
                        {
                            <div class="table-responsive" style="max-height: 300px;">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Guest</th>
                                            <th>Room</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var reservation in todayArrivals.Take(5))
                                        {
                                            <tr>
                                                <td>@reservation.GuestName</td>
                                                <td>@reservation.RoomNumber</td>
                                                <td>
                                                    <span class="badge bg-@GetReservationStatusColor(reservation.Status)">
                                                        @reservation.StatusName
                                                    </span>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted mb-0">No arrivals today</p>
                        }
                    </div>
                </div>
            </div>

            <!-- Active Check-Ins -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Current Guests (@currentGuests.Count)</h5>
                    </div>
                    <div class="card-body">
                        @if (currentGuests.Any())
                        {
                            <div class="table-responsive" style="max-height: 300px;">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Room</th>
                                            <th>Guests</th>
                                            <th>Checkout</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var checkIn in currentGuests.Take(10))
                                        {
                                            <tr>
                                                <td><strong>@checkIn.RoomNumber</strong></td>
                                                <td>
                                                    <div class="guest-names-inline">
                                                        @if (checkInGuests.ContainsKey(checkIn.Id))
                                                        {
                                                            @foreach (var guest in checkInGuests[checkIn.Id])
                                                            {
                                                                <span class="guest-badge">@guest.GuestName</span>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">@checkIn.Pax guests</span>
                                                        }
                                                    </div>
                                                </td>
                                                <td>
                                                    <small>@checkIn.CheckOutDate.ToShortDateString()</small>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted mb-0">No active check-ins</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isAuthenticated = false;
    private bool loading = true;
    private int totalRooms = 0;
    private int availableCount = 0;
    private int occupiedCount = 0;
    private int dirtyCount = 0;
    private int maintenanceCount = 0;
    private int blockedCount = 0;

    private List<RoomDto> rooms = new();
    private List<ReservationDto> todayArrivals = new();
    private List<CheckInDto> currentGuests = new();
    private Dictionary<int, (string GuestName, DateTime CheckoutDate)> roomOccupancy = new();
    private Dictionary<int, List<GuestDto>> checkInGuests = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isAuthenticated = await AuthService.IsAuthenticatedAsync();

            if (!isAuthenticated)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            await LoadDashboardData();
        }
        catch (Exception)
        {
            Navigation.NavigateTo("/login");
        }
    }

    private async Task LoadDashboardData()
    {
        loading = true;
        try
        {
            // Load all data
            rooms = await ApiClient.GetRoomsAsync();
            var checkIns = await ApiClient.GetActiveCheckInsAsync();
            var reservations = await ApiClient.GetUpcomingReservationsAsync();

            totalRooms = rooms.Count;

            // Calculate status counts
            availableCount = rooms.Count(r => r.RoomStatus == 0);
            occupiedCount = rooms.Count(r => r.RoomStatus == 1);
            dirtyCount = rooms.Count(r => r.RoomStatus == 2);
            maintenanceCount = rooms.Count(r => r.RoomStatus == 3);
            blockedCount = rooms.Count(r => r.RoomStatus == 4);

            // Build room occupancy map
            foreach (var checkIn in checkIns)
            {
                var room = rooms.FirstOrDefault(r => r.RoomNumber == checkIn.RoomNumber);
                if (room != null)
                {
                    // Get guests for this check-in
                    var guests = await ApiClient.GetGuestsByCheckInIdAsync(checkIn.Id);
                    if (guests.Any())
                    {
                        var guestNames = string.Join(", ", guests.Select(g => g.GuestName));
                        roomOccupancy[room.RoomId] = (guestNames, checkIn.CheckOutDate);
                        checkInGuests[checkIn.Id] = guests;
                    }
                }
            }

            // Today's arrivals
            todayArrivals = reservations
                .Where(r => r.CheckInDate.Date == DateTime.Today && r.Status != 3) // Not cancelled
                .ToList();

            currentGuests = checkIns;
        }
        catch (Exception)
        {
            // Silent fail - dashboard will show zeros
        }
        finally
        {
            loading = false;
        }
    }

    private string GetRoomStatusClass(int status)
    {
        return status switch
        {
            0 => "available",
            1 => "occupied",
            2 => "dirty",
            3 => "maintenance",
            4 => "blocked",
            _ => "available"
        };
    }

    private string GetStatusColor(int status)
    {
        return status switch
        {
            0 => "success",      // Available
            1 => "danger",       // Occupied
            2 => "warning",      // Dirty
            3 => "secondary",    // Maintenance
            4 => "dark",         // Blocked
            _ => "secondary"
        };
    }

    private string GetReservationStatusColor(int status)
    {
        return status switch
        {
            0 => "warning",  // Pending
            1 => "info",     // Confirmed
            2 => "success",  // CheckedIn
            3 => "danger",   // Cancelled
            4 => "secondary", // NoShow
            _ => "secondary"
        };
    }

    private void SelectRoom(RoomDto room)
    {
        // Future: Navigate to room details or perform action
    }
}
